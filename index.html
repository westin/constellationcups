<!DOCTYPE html>
<html>

<head>
  <script type="text/javascript" src="paper-full.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
  <!-- <script type="text/paperscript" src="animation.js" canvas="mainCanvas"></script> -->
  <!-- <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCkhKwouCV58ow89MNOIDFQDJbJfR11-xU&signed_in=true&callback=init" async defer></script> -->
  <script type="text/javascript" src="http://maps.google.com/maps/api/js"></script>
</head>
<style>
  * {
    margin: 0;
    padding: 0;
  }

  html,
  body {
    background-color: #f4f4f4;
  }

  #map {
    height: 400px;
    width: 800px;
    visibility: hidden;
  }

  canvas {
    background: #f4f4f4;
    height: 400px;
    width: 800px;
  }
</style>

<body>
  <canvas id="mainCanvas" resize keepalive="true"></canvas>
  <div id="map"></div>
  <script type="text/javascript">
    var map;
    var LatLngControl;

    function LatLngControl(map) {
      this.setMap(map);
    }

    LatLngControl.prototype = new google.maps.OverlayView();
    LatLngControl.prototype.draw = function() {};

    LatLngControl.prototype.updatePosition = function(latLng) {
      var projection = this.getProjection();
      var point = projection.fromLatLngToContainerPixel(latLng);

      return ([point.x, point.y])
    };


    function init() {
      var directionsService = new google.maps.DirectionsService;
      var centerLatLng = new google.maps.LatLng(37.748582, -122.418411);
      map = new google.maps.Map(document.getElementById('map'), {
        'zoom': 10,
        'center': centerLatLng,
        'mapTypeId': google.maps.MapTypeId.ROADMAP
      });


      latLngControl = new LatLngControl(map);

      getDirections(directionsService, "chicago, il", "cicero, il");
    }


    function getDirections(directionsService, start, end) {
      directionsService.route({
        origin: start,
        destination: end,
        travelMode: google.maps.TravelMode.WALKING
      }, function(response, status) {
        if (status === google.maps.DirectionsStatus.OK) {
          makeLines(getDirectionSteps(response))
        } else {
          window.alert('Directions request failed due to ' + status);
        }
      });
    }

    function getDirectionSteps(response) {
      var bounds = new google.maps.LatLngBounds();
      var directionSteps = []
      var legs = response.routes[0].legs;
      $(legs).each(function(index, item) {
        $(item.steps).each(function(index, item) {
          var legPoints = []
          $(item.path).each(function(index, item) {
            bounds.extend(item);
            legPoints.push([item.lat(), item.lng()])
          });
          var step = {
            step: index + 1,
            instructions: item.instructions,
            distance: item.distance.text,
            duration: item.duration.text,
            points: legPoints
          }
          directionSteps.push(step)
        });
      });
      map.fitBounds(bounds);
      return directionSteps
    }

    paper.install(window);
    paper.setup('mainCanvas');

    function makeLines(directionSteps) {
      var directionPath = new Path();
      directionPath.strokeColor = 'black';
      directionPath.strokeWidth = 2;
      directionPath.dashArray = [2, 5];
      $(directionSteps).each(function(index, item) {
        for (i = 0; i < item.points.length; i++) {
          var pixelCoords = latLngControl.updatePosition(new google.maps.LatLng(item.points[i][0], item.points[i][1]))
          console.log(pixelCoords)
          directionPath.add(new Point(pixelCoords[0], pixelCoords[1]))
        }
      })
      view.draw();
    }

    google.maps.event.addDomListener(window, 'load', init);
  </script>
</body>

</html>
